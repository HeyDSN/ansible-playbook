---
- name: Proxmox Backup Integrity Check
  hosts: proxmox_node
  become: yes
  vars:
    ansible_ssh_args: '-o ControlMaster=no -o ControlPersist=no'
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    proxmox_api_user: "root@pam"
    proxmox_api_password: "{{ lookup('env', 'PROXMOX_API_PASSWORD') }}"
    discord_webhook: "{{ lookup('env', 'ADW_PB_CHECK') }}"
    backup_storage: "adata-dir"  # Change this if you use a different storage for backups

  tasks:
    - name: Get list of backups
      shell: |
        find /mnt/pve/{{ backup_storage }}/dump -name "vzdump-*-*_*_*-*_*_*.*.zst" | sort
      register: backup_list
      changed_when: false

    - name: Verify backup integrity
      shell: |
        filename=$(basename "{{ item }}")
        vmid=$(echo $filename | sed -E 's/vzdump-(lxc|qemu)-([0-9]+)-.*$/\2/')
        vzdump verify --vmid $vmid "{{ item }}"
      loop: "{{ backup_list.stdout_lines }}"
      register: verify_result
      ignore_errors: yes

    - name: Prepare backup integrity report
      set_fact:
        integrity_report:
          embeds:
            - title: "ðŸ” Proxmox Backup Integrity Report"
              color: 3066993
              fields:
                - name: "ðŸ’¾ Total Backups"
                  value: "{{ backup_list.stdout_lines | length }}"
                  inline: true
                - name: "âœ… Verified Backups"
                  value: "{{ verify_result.results | selectattr('rc', 'eq', 0) | list | length }}"
                  inline: true
                - name: "âŒ Failed Verifications"
                  value: "{{ verify_result.results | selectattr('rc', 'ne', 0) | list | length }}"
                  inline: true
              description: |-
                **ðŸ“Š Backup Integrity Details:**
                ```
                {% for result in verify_result.results %}
                â€¢ {{ result.item | basename }}: {{ 'Passed' if result.rc == 0 else 'Failed' }}
                {% endfor %}
                ```
                {% if verify_result.results | selectattr('rc', 'ne', 0) | list | length > 0 %}
                **âš ï¸ Failed Verifications:**
                ```
                {% for result in verify_result.results | selectattr('rc', 'ne', 0) | list %}
                â€¢ {{ result.item | basename }}
                  Error: {{ result.stderr_lines | join(' ') }}
                {% endfor %}
                ```
                {% endif %}

    - name: Send Discord notification
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body: "{{ integrity_report }}"
        status_code: [204, 200]
      when: discord_webhook | length > 0

    - name: Display integrity report (Debug)
      debug:
        var: integrity_report
