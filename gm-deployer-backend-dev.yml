---
- name: Redeploy Docker Compose Services - Dev
  hosts: ovh_master
  gather_facts: no
  become: yes
  vars:
    ansible_remote_tmp: /tmp
    ansible_ssh_args: "-o ControlMaster=auto -o ControlPersist=10m"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
    manage_api_backend_dir: /home/debian/manage-api-backend/dev
    global_timeout: 600 # 10 minutes in seconds
  tasks:
    - name: Change to manage-api-backend directory and stop Docker Compose services
      become: yes
      become_user: debian
      shell: cd {{ manage_api_backend_dir }} && docker compose down
      register: docker_down_result
      failed_when: docker_down_result.rc != 0
      # Add timeout to prevent hanging
      async: "{{ global_timeout }}"
      poll: 5

    - name: Pull latest Docker images
      become: yes
      become_user: debian
      shell: cd {{ manage_api_backend_dir }} && docker compose pull
      register: docker_pull_result
      failed_when: docker_pull_result.rc != 0
      # Add timeout to prevent hanging
      async: "{{ global_timeout }}"
      poll: 5

    - name: Start Docker Compose services with new images
      become: yes
      become_user: debian
      shell: cd {{ manage_api_backend_dir }} && docker compose up -d
      register: docker_up_result
      failed_when: docker_up_result.rc != 0
      # Add timeout to prevent hanging
      async: "{{ global_timeout }}"
      poll: 5

    - name: Check Docker Compose services status
      become: yes
      become_user: debian
      shell: cd {{ manage_api_backend_dir }} && docker compose ps
      register: docker_ps_result
      failed_when: docker_ps_result.rc != 0
      # Add timeout to prevent hanging
      async: 30
      poll: 5

    - name: Display Docker Compose services status
      debug:
        var: docker_ps_result.stdout_lines
